# logduration
logduration is a project that originally started simply to provide a quick and easy way to observe all kernel
durations within an application, without having to run the profiler and be saddled with all of the application
perturbation profiling involves (e.g. kernels are serialized). It's going to end up doing more than that though.

I've long had an interest in creating the capability to silently replace kernel objects in dispatch packets with
alternatives so that developers can experiment without having to rebuild entire applications. So I'm adding
the ability to logduration to point it at a kernel cache. What it wants is a directory containing any number of hsaco
files generated by the compiler. As the tool observes and logs kernel durations, which it pries out of
the dispatch completion_signal, if it finds a kernel in the kernel cache, with and identical name and parameter list,
it will silently replace the kernel the app dispatched with an equivalent kernel from the kernel cache.

Silently replacing kernels is a technique the Audacious Software team plans to use for its instrumented kernel functionality. 
But I suspect it will be really useful even just for doing comparative performance analysis while avoiding
the rebuilding of entire applications.
## Running
HSA_TOOLS_LIB=\<path to liblogdur64.so\> <your application here\>  

e.g. HSA_TOOLS_LIB=./build/liblogdur64.so ./src/test/quicktest
## Environment Variables
- LOGDUR_LOG_LOCATION
  - console
  - file name
  - /dev/null
- LOGDUR_KERNEL_CACHE
  - The kernel cache should be pointed at a directory containing .hsaco files which represented alternative candidates
  to the kernels being dispatched by the application. If running "instrumented kernels" (see the next environment variable description), logDuration
  will look for an identically named kernel with the same parameter list and types, but with a single additional void * parameter (needed for the
  data streaming to the host from instrumented kernels.) If logDuration is not running in instrumented mode (e.g. LOGDUR_INSTRUMENTED = "false"),
  when the kernel cache is enabled it will look for kernels in the cache having identical names and parameters. This can be useful when wanting
  to compare different versions of the same kernel for overall duration.
- LOGDUR_INSTRUMENTED
  - Value can be either "true" or "false". If set to "true", the kernel cache with replace dispatched kernels with an instrumented alternative.
## Building  
This project now depends on the [dh_comms](https://github.com/AARInternal/dh_comms) library and the [instrument-amdgpu-kernels](https://github.com/CRobeck/instrument-amdgpu-kernels) tool. By default, both of these dependencies will be pulled into this project via CMake's [FetchContent](https://cmake.org/cmake/help/latest/module/FetchContent.html) module.

```shell
  git clone https://github.com/AARInternal/logduration.git
  cd logduration
  mkdir build
  cd build
  cmake ..
  make
```

> [!TIP]
> Add the `-DCMAKE_INSTALL_PREFIX` flag to your CMake command to install to a standard location on your system. Don't forget to use `make install`.

## Dependencies
logDuration is now dependent on two other libraries for building, and a third library if you want to use logDuration as part of omniprobe.
### [kerneldb](https://github.com/AARInternal/kerneldb.git)
> kernelDB provides support for query kernel codes from HSA code objects. This can be an important capability for processing instrumented kernel output.
> The omniprobe memory efficiency analyzer relies on this because sometimes code optimizations are made downstream in the compiler from where instrumentation
> occurred. And proper analysis of, say, memory traces requires understanding how the code may have been optimized (e.g. ganging together individual loads into dwordx4)

### [dh_comms](https://github.com/AARInternal/dh_comms.git)
> dh_comms provides buffered I/O functionality for propagating messages from instrumented kernels to host code for consuming and analyzing messages from instrumented code at runtime.
> Because logDuration can run in either instrumented or non-instrumented mode, dh_comms functionality needs to be built into logDuration.
> 
### [instrument-amdgpu-kernels](https://github.com/CRobeck/instrument-amdgpu-kernels.git)
> Unlike either dh_comms or kerneldb, instrument-amdgpu-kernel does not get linked into logDuration, but the llvm plugins provided by this library do the instrumentation of GPU kernels
> that logDuration relies on when running in instrumented mode. For now, when you build instrument-amdgpu-kernels for logDuration, you need to use the dh_comms_submit_address branch.
