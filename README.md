# logduration
logduration is a project that originally started simply to provide a quick and easy way to observe all kernel
durations within an application, without having to run the profiler and be saddled with all of the application
perturbation profiling involves (e.g. kernels are serialized). It's going to end up doing more than that though.

I've long had an interest in creating the capability to silently replace kernel objects in dispatch packets with
alternatives so that developers can experiment without having to rebuild entire applications. So I'm adding
the ability to logduration to point it at a kernel cache. What it wants is a directory containing any number of hsaco
files generated by the compiler. As the tool observes and logs kernel durations, which it pries out of
the dispatch completion_signal, if it finds a kernel in the kernel cache, with and identical name and parameter list,
it will silently replace the kernel the app dispatched with an equivalent kernel from the kernel cache.

Silently replacing kernels is a technique the Audacious Software team plans to use for its instrumented kernel functionality. 
But I suspect it will be really useful even just for doing comparative performance analysis while avoiding
the rebuilding of entire applications.
## Running
HSA_TOOLS_LIB=\<path to liblogdur64.so\> <your application here\>  

e.g. HSA_TOOLS_LIB=./build/liblogdur64.so ./src/test/quicktest
## Environment Variables
- LOGDUR_LOG_LOCATION
  - console
  - file name
  - /dev/null
- LOGDUR_KERNEL_CACHE
  - The kernel cache should be pointed at a directory containing .hsaco files which represented alternative candidates
  to the kernels being dispatched by the application. If running "instrumented kernels" (see the next environment variable description), logDuration
  will look for an identically named kernel with the same parameter list and types, but with a single additional void * parameter (needed for the
  data streaming to the host from instrumented kernels.) If logDuration is not running in instrumented mode (e.g. LOGDUR_INSTRUMENTED = "false"),
  when the kernel cache is enabled it will look for kernels in the cache having identical names and parameters. This can be useful when wanting
  to compare different versions of the same kernel for overall duration.
- LOGDUR_INSTRUMENTED
  - Value can be either "true" or "false". If set to "true", the kernel cache with replace dispatched kernels with an instrumented alternative.
## Building  
This project now depends on the [dh_comms](https://github.com/AARInternal/dh_comms) library and the [instrument-amdgpu-kernels](https://github.com/CRobeck/instrument-amdgpu-kernels) tool. By default, both of these dependencies will be pulled into this project via CMake's [FetchContent](https://cmake.org/cmake/help/latest/module/FetchContent.html) module.

```shell
  git clone https://github.com/AARInternal/logduration.git
  cd logduration
  mkdir build
  cd build
  cmake ..
  make
```

> [!TIP]
> Add the `-DCMAKE_INSTALL_PREFIX` flag to your CMake command to install to a standard location on your system. Don't forget to use `make install`.